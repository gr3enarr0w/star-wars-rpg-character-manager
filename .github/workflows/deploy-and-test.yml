name: Deploy and Test in GitHub Codespaces

on:
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'Scope of testing to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - api-security-only
        - ui-admin-only
        - ui-all-roles-only
        - character-creation-only
  push:
    branches: [ main ]
    paths:
    - 'src/**'
    - 'web/**'
    - 'tests/**'
    - 'Dockerfile'
    - 'docker-compose.yml'

env:
  MONGODB_URI: "mongodb://admin:password123@localhost:27017/swrpg_characters?authSource=admin"
  JWT_SECRET_KEY: "github-codespaces-testing-secret-key-2024"
  FLASK_ENV: "production"

jobs:
  deploy-and-test-x64:
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password123
          MONGO_INITDB_DATABASE: swrpg_characters
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ—ï¸ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ Set up Python environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ðŸ“¦ Install Python dependencies
      run: |
        echo "ðŸ“¦ Installing application dependencies..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ðŸš€ Start application directly
      run: |
        echo "ðŸš€ Starting application with Python..."
        export MONGODB_URI="${{ env.MONGODB_URI }}"
        export JWT_SECRET_KEY="${{ env.JWT_SECRET_KEY }}"
        export FLASK_ENV="${{ env.FLASK_ENV }}"
        export PYTHONPATH="$(pwd)/src"
        echo "MongoDB URI: $MONGODB_URI"
        echo "Waiting for MongoDB service to be ready..."
        python -c "
import time
import pymongo
import sys
for i in range(12):
    try:
        client = pymongo.MongoClient('$MONGODB_URI', serverSelectionTimeoutMS=5000)
        client.admin.command('ping')
        print('âœ… MongoDB is ready!')
        break
    except Exception as e:
        print(f'Attempt {i+1}/12: MongoDB not ready, waiting... ({e})')
        time.sleep(5)
else:
    print('âŒ MongoDB failed to become ready')
    sys.exit(1)
"
        echo "Starting application..."
        nohup python startup.py > app.log 2>&1 &
        echo $! > app.pid
        echo "Application started with PID $(cat app.pid)"
        sleep 10
        echo "Application log preview:"
        tail -20 app.log || echo "No logs yet"

    - name: â³ Wait for application to be ready
      run: |
        echo "â³ Waiting for application to start..."
        echo "Checking if application process is running:"
        ps aux | grep python || echo "No python process found"
        echo "Trying to connect to health endpoint..."
        for i in {1..40}; do
          if curl -f http://localhost:8000/health; then
            echo "âœ… Application is ready!"
            exit 0
          else
            echo "Attempt $i/40: Health check failed, retrying in 3 seconds..."
            echo "Current application log:"
            tail -5 app.log 2>/dev/null || echo "No logs available"
            sleep 3
          fi
        done
        echo "âŒ Application failed to become ready after 120 seconds"
        echo "Final application log:"
        cat app.log 2>/dev/null || echo "No logs available"
        exit 1

    - name: ðŸŽ¯ Set up Node.js for Playwright testing
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ðŸ“¦ Install testing dependencies
      run: |
        echo "ðŸ“¦ Installing Playwright and dependencies..."
        npm init -y
        npm install --save-dev playwright @playwright/test
        npx playwright install --with-deps

    - name: ðŸ‘¤ Create admin user
      run: |
        echo "ðŸ‘¤ Creating admin user for testing..."
        export PYTHONPATH="$(pwd)/src"
        python create_admin_user.py

    - name: ðŸ§ª Create test results directory
      run: |
        mkdir -p test-results
        echo "ðŸ“ Test results directory created"

    - name: ðŸ”’ Run API Security Tests
      if: ${{ github.event.inputs.test_scope == 'all' || github.event.inputs.test_scope == 'api-security-only' }}
      run: |
        echo "ðŸ”’ Running comprehensive API security tests..."
        npx playwright test tests/api-security-comprehensive.spec.js --reporter=list --output-dir=test-results

    - name: ðŸ›ï¸ Run Admin UI Tests
      if: ${{ github.event.inputs.test_scope == 'all' || github.event.inputs.test_scope == 'ui-admin-only' }}
      run: |
        echo "ðŸ›ï¸ Running comprehensive admin UI tests..."
        npx playwright test tests/ui-admin-comprehensive.spec.js --reporter=list --output-dir=test-results

    - name: ðŸ‘¥ Run All Roles UI Tests
      if: ${{ github.event.inputs.test_scope == 'all' || github.event.inputs.test_scope == 'ui-all-roles-only' }}
      run: |
        echo "ðŸ‘¥ Running all user roles UI tests..."
        npx playwright test tests/ui-all-roles-comprehensive.spec.js --reporter=list --output-dir=test-results

    - name: âš”ï¸ Run Character Creation Tests
      if: ${{ github.event.inputs.test_scope == 'all' || github.event.inputs.test_scope == 'character-creation-only' }}
      run: |
        echo "âš”ï¸ Running comprehensive character creation tests..."
        npx playwright test tests/character-creation-comprehensive.spec.js --reporter=list --output-dir=test-results

    - name: ðŸ“Š Generate comprehensive test report
      if: always()
      run: |
        echo "ðŸ“Š Generating test reports..."
        npx playwright show-report --reporter=html

    - name: ðŸ“¸ Upload screenshots and test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-test-results
        path: test-results/
        retention-days: 30

    - name: ðŸ“‹ Upload HTML test report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-html-report
        path: playwright-report/
        retention-days: 30

    - name: ðŸ“ Collect application logs
      if: always()
      run: |
        echo "ðŸ“ Collecting application logs..."
        cp app.log application.log 2>/dev/null || echo "Could not collect logs"
        
    - name: ðŸ“‹ Upload application logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: application-logs
        path: application.log
        retention-days: 30

    - name: ðŸ¥ Final health checks
      if: always()
      run: |
        echo "ðŸ¥ Running final health checks..."
        echo "Application health:"
        curl -f http://localhost:8000/health || echo "âŒ Health check failed"
        echo -e "\nLogin endpoint:"
        curl -f http://localhost:8000/login || echo "âŒ Login endpoint not accessible"
        echo -e "\nApplication process:"
        ps aux | grep python || echo "âŒ Python process not running"

    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up..."
        if [ -f app.pid ]; then
          kill $(cat app.pid) 2>/dev/null || true
          rm -f app.pid
        fi

  test-summary:
    needs: deploy-and-test-x64
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“Š Test Summary
      run: |
        echo "## ðŸŽ¯ GitHub Codespaces Testing Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Platform**: x64 Ubuntu (GitHub Codespaces environment)" >> $GITHUB_STEP_SUMMARY
        echo "- **Application**: Star Wars RPG Character Manager" >> $GITHUB_STEP_SUMMARY
        echo "- **Database**: MongoDB 7.0" >> $GITHUB_STEP_SUMMARY
        echo "- **Testing Framework**: Playwright" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ§ª Tests Executed" >> $GITHUB_STEP_SUMMARY
        echo "- **API Security Testing**: Comprehensive authentication and authorization tests" >> $GITHUB_STEP_SUMMARY
        echo "- **Admin UI Testing**: Complete admin interface functionality" >> $GITHUB_STEP_SUMMARY
        echo "- **Multi-Role UI Testing**: Admin, User, and Gamemaster role testing" >> $GITHUB_STEP_SUMMARY
        echo "- **Character Creation**: All 55+ species and career combinations" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Artifacts Available" >> $GITHUB_STEP_SUMMARY
        echo "- Screenshots from all test scenarios" >> $GITHUB_STEP_SUMMARY
        echo "- HTML test reports with detailed results" >> $GITHUB_STEP_SUMMARY
        echo "- Application logs for debugging" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: ${{ needs.deploy-and-test-x64.result }}" >> $GITHUB_STEP_SUMMARY